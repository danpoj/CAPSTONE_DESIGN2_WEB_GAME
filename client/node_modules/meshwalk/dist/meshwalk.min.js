!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.MW={})}(this,function(t){"use strict";var T=void 0;function c(t,e,i,n){var o=void 0,r=void 0,s=void 0,a=void 0,c=(new THREE.Vector3).addVectors(n.max,n.min).multiplyScalar(.5),h=(new THREE.Vector3).subVectors(n.max,c),u=(new THREE.Vector3).subVectors(t,c),l=(new THREE.Vector3).subVectors(e,c),d=(new THREE.Vector3).subVectors(i,c),f=(new THREE.Vector3).subVectors(l,u),m=(new THREE.Vector3).subVectors(d,l),p=(new THREE.Vector3).subVectors(u,d),y=new THREE.Vector3(0,-f.z,f.y),v=new THREE.Vector3(0,-m.z,m.y),g=new THREE.Vector3(0,-p.z,p.y),b=new THREE.Vector3(f.z,0,-f.x),E=new THREE.Vector3(m.z,0,-m.x),x=new THREE.Vector3(p.z,0,-p.x),w=new THREE.Vector3(-f.y,f.x,0),M=new THREE.Vector3(-m.y,m.x,0),R=new THREE.Vector3(-p.y,p.x,0);if(o=u.dot(y),r=l.dot(y),s=d.dot(y),a=h.y*Math.abs(f.z)+h.z*Math.abs(f.y),Math.max(-Math.max(o,r,s),Math.min(o,r,s))>a)return!1;if(o=u.dot(v),r=l.dot(v),s=d.dot(v),a=h.y*Math.abs(m.z)+h.z*Math.abs(m.y),Math.max(-Math.max(o,r,s),Math.min(o,r,s))>a)return!1;if(o=u.dot(g),r=l.dot(g),s=d.dot(g),a=h.y*Math.abs(p.z)+h.z*Math.abs(p.y),Math.max(-Math.max(o,r,s),Math.min(o,r,s))>a)return!1;if(o=u.dot(b),r=l.dot(b),s=d.dot(b),a=h.x*Math.abs(f.z)+h.z*Math.abs(f.x),Math.max(-Math.max(o,r,s),Math.min(o,r,s))>a)return!1;if(o=u.dot(E),r=l.dot(E),s=d.dot(E),a=h.x*Math.abs(m.z)+h.z*Math.abs(m.x),Math.max(-Math.max(o,r,s),Math.min(o,r,s))>a)return!1;if(o=u.dot(x),r=l.dot(x),s=d.dot(x),a=h.x*Math.abs(p.z)+h.z*Math.abs(p.x),Math.max(-Math.max(o,r,s),Math.min(o,r,s))>a)return!1;if(o=u.dot(w),r=l.dot(w),s=d.dot(w),a=h.x*Math.abs(f.y)+h.y*Math.abs(f.x),Math.max(-Math.max(o,r,s),Math.min(o,r,s))>a)return!1;if(o=u.dot(M),r=l.dot(M),s=d.dot(M),a=h.x*Math.abs(m.y)+h.y*Math.abs(m.x),Math.max(-Math.max(o,r,s),Math.min(o,r,s))>a)return!1;if(o=u.dot(R),r=l.dot(R),s=d.dot(R),a=h.x*Math.abs(p.y)+h.y*Math.abs(p.x),Math.max(-Math.max(o,r,s),Math.min(o,r,s))>a)return!1;if(Math.max(u.x,l.x,d.x)<-h.x||Math.min(u.x,l.x,d.x)>h.x)return!1;if(Math.max(u.y,l.y,d.y)<-h.y||Math.min(u.y,l.y,d.y)>h.y)return!1;if(Math.max(u.z,l.z,d.z)<-h.z||Math.min(u.z,l.z,d.z)>h.z)return!1;var V,T,k,H,P,z,_=new THREE.Plane;return _.normal=(new THREE.Vector3).copy(m).cross(f).normalize(),_.constant=_.normal.dot(t),V=n,T=_,k=(new THREE.Vector3).addVectors(V.max,V.min).multiplyScalar(.5),H=(new THREE.Vector3).subVectors(V.max,k),P=H.x*Math.abs(T.normal.x)+H.y*Math.abs(T.normal.y)+H.z*Math.abs(T.normal.z),z=T.normal.dot(k)-T.constant,Math.abs(z)<=P}function u(t,e){var i=0;return t.center.x<e.min.x&&(i+=(e.min.x-t.center.x)*(e.min.x-t.center.x)),t.center.x>e.max.x&&(i+=(t.center.x-e.max.x)*(t.center.x-e.max.x)),t.center.y<e.min.y&&(i+=(e.min.y-t.center.y)*(e.min.y-t.center.y)),t.center.y>e.max.y&&(i+=(t.center.y-e.max.y)*(t.center.y-e.max.y)),t.center.z<e.min.z&&(i+=(e.min.z-t.center.z)*(e.min.z-t.center.z)),t.center.z>e.max.z&&(i+=(t.center.z-e.max.z)*(t.center.z-e.max.z)),i<=t.radius*t.radius}function o(t,e,i,n,o){var r=(new THREE.Vector3).subVectors(e,t.center),s=(new THREE.Vector3).subVectors(i,t.center),a=(new THREE.Vector3).subVectors(n,t.center),c=t.radius*t.radius,h=(new THREE.Vector3).crossVectors(s.clone().sub(r),a.clone().sub(r)),u=r.dot(h),l=h.dot(h);if(c*l<u*u)return!1;var d=r.dot(r),f=r.dot(s),m=r.dot(a),p=s.dot(s),y=s.dot(a),v=a.dot(a);if(c<d&d<f&d<m||c<p&p<f&p<y||c<v&v<m&v<y)return!1;var g=(new THREE.Vector3).subVectors(s,r),b=(new THREE.Vector3).subVectors(a,s),E=(new THREE.Vector3).subVectors(r,a),x=f-d,w=y-p,M=m-v,R=g.dot(g),V=b.dot(b),T=E.dot(E),k=(new THREE.Vector3).subVectors(r.multiplyScalar(R),g.multiplyScalar(x)),H=(new THREE.Vector3).subVectors(s.multiplyScalar(V),b.multiplyScalar(w)),P=(new THREE.Vector3).subVectors(a.multiplyScalar(T),E.multiplyScalar(M)),z=(new THREE.Vector3).subVectors(a.multiplyScalar(R),k),_=(new THREE.Vector3).subVectors(r.multiplyScalar(V),H),S=(new THREE.Vector3).subVectors(s.multiplyScalar(T),P);if(k.dot(k)>c*R*R&&0<=k.dot(z)||H.dot(H)>c*V*V&&0<=H.dot(_)||P.dot(P)>c*T*T&&0<=P.dot(S))return!1;var O=Math.sqrt(u*u/l)-t.radius-1,L=new THREE.Vector3(-o.x,-o.y,-o.z);return{distance:O,contactPoint:t.center.clone().add(L.multiplyScalar(O))}}function h(t,e,i,n,o){var r=n.clone().sub(i),s=o.clone().sub(i),a=t.clone().sub(e),c=r.clone().cross(s),h=a.dot(c);if(h<=0)return!1;var u=t.clone().sub(i),l=u.dot(c);if(l<0)return 0;if(h<l)return 0;var d=a.clone().cross(u),f=s.dot(d);if(f<0||h<f)return 0;var m=-1*r.clone().dot(d);if(m<0||h<f+m)return 0;var p=1/h;l*=p;var y=1-(f*=p)-(m*=p),v=i.clone().multiplyScalar(y),g=n.clone().multiplyScalar(f),b=o.clone().multiplyScalar(m);return{contactPoint:v.clone().add(g).add(b)}}var e=function(){function n(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}}();function y(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var l=function(){function p(t,e,i){y(this,p),this.min=t,this.max=e,this.maxDepth=i,this.nodes=[],this.isOctree=!0;for(var n=new T.Vector3,o=new T.Vector3,r=new T.Vector3,s=0;s<this.maxDepth;s++){this.nodes.push([]);var a=Math.pow(2,s),c=Math.pow(4,s);n.subVectors(this.max,this.min).divideScalar(a);for(var h=0,u=Math.pow(8,s);h<u;h++){var l=h%a,d=h/c|0,f=(h/a|0)%a;o.set(this.min.x+l*n.x,this.min.y+d*n.y,this.min.z+f*n.z),r.copy(o).add(n);var m=p.getMortonNumber(l,d,f);this.nodes[s][m]=new v(this,s,m,o,r)}}}return e(p,[{key:"importThreeMesh",value:function(t){t.updateMatrix();var e=t.geometry.uuid,i=t.geometry.clone();if(i.applyMatrix(t.matrix),i.computeVertexNormals(),i instanceof T.BufferGeometry){if(void 0!==i.index)for(var n=i.index.array,o=i.attributes.position.array,r=0!==i.groups.length?i.groups:[{start:0,count:n.length,index:0}],s=0,a=r.length;s<a;++s)for(var c=r[s].start,h=r[s].count,u=r[s].materialIndex,l=c,d=c+h;l<d;l+=3){var f=u+n[l],m=u+n[l+1],p=u+n[l+2],y=(new T.Vector3).fromArray(o,3*f),v=(new T.Vector3).fromArray(o,3*m),g=(new T.Vector3).fromArray(o,3*p),b=(new T.Vector3).subVectors(g,v),E=(new T.Vector3).subVectors(y,v),x=b.cross(E).normalize().clone(),w=new k(y,v,g,x,e);this.addFace(w)}}else{i.computeFaceNormals();for(var M=0,R=i.faces.length;M<R;M++){var V=new k(i.vertices[i.faces[M].a],i.vertices[i.faces[M].b],i.vertices[i.faces[M].c],i.faces[M].normal,e);this.addFace(V)}}}},{key:"addFace",value:function(t){for(var e=[],i=this.nodes[0].slice(0),n=0,o=this.maxDepth;n<o;n++){for(var r=0,s=i.length;r<s;r++){var a=i[r];c(t.a,t.b,t.c,a)&&(a.trianglePool.push(t),n+1!==this.maxDepth&&(e=e.concat(a.getChildNodes())))}if(0===e.length)break;i=e.slice(0),e.length=0}}},{key:"removeThreeMesh",value:function(i){this.nodes.forEach(function(t){t.forEach(function(t){var e=[];t.trianglePool.forEach(function(t){t.meshID!==i&&e.push(t)}),t.trianglePool=e})})}},{key:"getIntersectedNodes",value:function(t,e){var i=[],n=[];if(!u(t,this))return[];for(var o=this.nodes[0].slice(0),r=0,s=e;r<s;r++){for(var a=0,c=o.length;a<c;a++){var h=o[a];if(u(t,h))r+1===e?0!==h.trianglePool.length&&n.push(h):i=i.concat(h.getChildNodes())}o=i.slice(0),i.length=0}return n}}]),p}();l.separate3Bit=function(t){return t=2396745&((t=798915&((t=61455&(t|t<<8))|t<<4))|t<<2)},l.getMortonNumber=function(t,e,i){return l.separate3Bit(t)|l.separate3Bit(e)<<1|l.separate3Bit(i)<<2},l.uniqTriangkesfromNodes=function(t){var e=[],i=!1;if(0===t.length)return[];if(1===t.length)return t[0].trianglePool.slice(0);for(var n=0,o=t.length;n<o;n++)for(var r=0,s=t[n].trianglePool.length;r<s;r++){for(var a=0,c=e.length;a<c;a++)t[n].trianglePool[r]===e[a]&&(i=!0);i||e.push(t[n].trianglePool[r]),i=!1}return e};var v=function(){function r(t,e,i,n,o){y(this,r),this.tree=t,this.depth=e,this.mortonNumber=i,this.min=new T.Vector3(n.x,n.y,n.z),this.max=new T.Vector3(o.x,o.y,o.z),this.trianglePool=[]}return e(r,[{key:"getParentNode",value:function(){if(0===this.depth)return null;this.tree.nodes[this.depth][this.mortonNumber>>3]}},{key:"getChildNodes",value:function(){if(this.tree.maxDepth===this.depth)return null;var t=this.mortonNumber<<3;return[this.tree.nodes[this.depth+1][t],this.tree.nodes[this.depth+1][t+1],this.tree.nodes[this.depth+1][t+2],this.tree.nodes[this.depth+1][t+3],this.tree.nodes[this.depth+1][t+4],this.tree.nodes[this.depth+1][t+5],this.tree.nodes[this.depth+1][t+6],this.tree.nodes[this.depth+1][t+7]]}}]),r}(),k=function t(e,i,n,o,r){y(this,t),this.a=e.clone(),this.b=i.clone(),this.c=n.clone(),this.normal=o.clone(),this.meshID=r},i=function(){function n(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}}();var n=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.colliderPool=[],this.characterPool=[]}return i(t,[{key:"add",value:function(t){t.isOctree?this.colliderPool.push(t):t.isCharacterController&&(this.characterPool.push(t),t.world=this)}},{key:"step",value:function(t){for(var e=0,i=this.characterPool.length;e<i;e++){for(var n=this.characterPool[e],o=void 0,r=0,s=this.colliderPool.length;r<s;r++){var a=this.colliderPool[r],c=new T.Sphere(n.center,n.radius+n.groundPadding),h=a.getIntersectedNodes(c,a.maxDepth);o=l.uniqTriangkesfromNodes(h)}n.collisionCandidate=o,n.update(t)}}}]),t}(),r=function(){function n(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}}();var m=2*Math.PI,p=function(t,e){return(t%e+e)%e},s=function(){function o(t){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,o),this.mesh=t,this.motion={},this.mixer=new THREE.AnimationMixer(t),this.currentMotionName="";for(var e=0,i=this.mesh.geometry.animations.length;e<i;e++){var n=this.mesh.geometry.animations[e];this.motion[n.name]=this.mixer.clipAction(n),this.motion[n.name].setEffectiveWeight(1)}}return r(o,[{key:"play",value:function(t){if(this.currentMotionName!==t){if(this.motion[this.currentMotionName]){var e=this.motion[this.currentMotionName].play(),i=this.motion[t].play();e.enabled=!0,i.enabled=!0,e.crossFadeTo(i,.3)}else this.motion[t].enabled=!0,this.motion[t].play();this.currentMotionName=t}}},{key:"turn",value:function(t,e){var i,n,o,r,s=this,a=this.mesh.rotation.y,c=t,h=(o=p((i=a)-(n=c),m),r=p(n-i,m),o<r?-o:r),u=Date.now(),l=u+200,d=0;if(e)this.mesh.rotation.y=c;else if(this._targetRotY!==c){var f=this._targetRotY=c;!function t(){var e=Date.now();if(!(f!==s._targetRotY)){if(l<=e)return s.mesh.rotation.y=f,void delete s._targetRotY;requestAnimationFrame(t),d=(e-u)/200,s.mesh.rotation.y=a+h*d}}()}}},{key:"update",value:function(t){this.mixer.update(t)}}]),o}(),a=function(){function n(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}}();var d=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._listeners={}}return a(t,[{key:"addEventListener",value:function(t,e){var i=this._listeners;void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e)}},{key:"hasEventListener",value:function(t,e){var i=this._listeners;return void 0!==i[t]&&-1!==i[t].indexOf(e)}},{key:"removeEventListener",value:function(t,e){var i=this._listeners[t];if(void 0!==i){var n=i.indexOf(e);-1!==n&&i.splice(n,1)}}},{key:"dispatchEvent",value:function(t){var e=this._listeners[t.type];if(void 0!==e){t.target=this;for(var i=e.slice(0),n=0,o=i.length;n<o;n++)i[n].call(this,t)}}}]),t}(),f=function(){function n(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}}();var g=function(t){function c(t,e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,c);var i=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(c.__proto__||Object.getPrototypeOf(c)).call(this));i.isCharacterController=!0,i.object=t,i.center=i.object.position.clone(),i.radius=e,i.groundPadding=.5,i.maxSlopeGradient=Math.cos(50*THREE.Math.DEG2RAD),i.isGrounded=!1,i.isOnSlope=!1,i.isIdling=!1,i.isRunning=!1,i.isJumping=!1,i.direction=0,i.movementSpeed=10,i.velocity=new THREE.Vector3(0,-10,0),i.currentJumpPower=0,i.jumpStartTime=0,i.groundHeight=0,i.groundNormal=new THREE.Vector3,i.collisionCandidate,i.contactInfo=[];var n=!0,o=void 0,r=void 0,s=void 0,a=void 0;return i.events=function(){if(n)return n=!1,o=i.isGrounded,r=i.isOnSlope,i.isIdling,s=i.isRunning,void(a=i.isJumping);s||i.isRunning||!i.isGrounded||i.isIdling?!s&&i.isRunning&&!i.isJumping&&i.isGrounded||!o&&i.isGrounded&&i.isRunning||r&&!i.isOnSlope&&i.isRunning&&i.isGrounded?(i.isIdling=!1,i.dispatchEvent({type:"startWalking"})):!a&&i.isJumping?(i.isIdling=!1,i.dispatchEvent({type:"startJumping"})):!r&&i.isOnSlope?i.dispatchEvent({type:"startSliding"}):!o||i.isGrounded||i.isJumping||i.dispatchEvent({type:"startFalling"}):(i.isIdling=!0,i.dispatchEvent({type:"startIdling"})),!o&&i.isGrounded,o=i.isGrounded,r=i.isOnSlope,i.isIdling,s=i.isRunning,a=i.isJumping},i}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(c,d),f(c,[{key:"update",value:function(t){this.isGrounded=!1,this.isOnSlope=!1,this.groundHeight=-1/0,this.groundNormal.set(0,1,0),this.updateGrounding(),this.updateJumping(),this.updatePosition(t),this.collisionDetection(),this.solvePosition(),this.updateVelocity(),this.events()}},{key:"updateVelocity",value:function(){var t=-Math.cos(this.direction),e=-Math.sin(this.direction),i=!1;if(this.velocity.set(e*this.movementSpeed*this.isRunning,-20,t*this.movementSpeed*this.isRunning),0!==this.contactInfo.length||this.isJumping){if(!this.isGrounded||this.isOnSlope||this.isJumping)if(this.isOnSlope){var n=20/(1-this.groundNormal.y)*.2;this.velocity.x=this.groundNormal.x*n,this.velocity.y=-20,this.velocity.z=this.groundNormal.z*n}else this.isGrounded||this.isOnSlope||!this.isJumping||(this.velocity.y=20*this.currentJumpPower);else this.velocity.y=0;for(var o=new THREE.Vector2(e,t),r=Math.atan2(-o.y,-o.x),s=0,a=this.contactInfo.length;s<a;s++){var c=this.contactInfo[s].face.normal;if(!(this.maxSlopeGradient<c.y||this.isOnSlope)){!i&&c.y<0&&(i=!0);var h=new THREE.Vector2(c.x,c.z).normalize(),u=Math.atan2(h.y,h.x);Math.abs(r-u)>=.5*Math.PI&&Math.abs(r-u)<=1.5*Math.PI||(h.set(o.dot(h)*h.x,o.dot(h)*h.y),o.sub(h),this.velocity.x=o.x*this.movementSpeed*this.isRunning,this.velocity.z=o.y*this.movementSpeed*this.isRunning)}}i&&(this.velocity.y=Math.min(0,this.velocity.y),this.isJumping=!1)}}},{key:"updateGrounding",value:function(){for(var t=void 0,e=void 0,i=this.collisionCandidate,n=new THREE.Vector3(this.center.x,this.center.y+this.radius,this.center.z),o=new THREE.Vector3(this.center.x,this.center.y-1e10,this.center.z),r=0,s=i.length;r<s;r++)(e=h(n,o,i[r].a,i[r].b,i[r].c))&&!t?(t=e).face=i[r]:e&&e.contactPoint.y>t.contactPoint.y&&((t=e).face=i[r]);if(t){this.groundHeight=t.contactPoint.y,this.groundNormal.copy(t.face.normal);var a=n.y,c=this.center.y-this.radius-this.groundPadding;if(this.isJumping&&0<this.currentJumpPower)return this.isOnSlope=!1,void(this.isGrounded=!1);this.isGrounded=c<=this.groundHeight&&this.groundHeight<=a,this.isOnSlope=this.groundNormal.y<=this.maxSlopeGradient,this.isGrounded&&(this.isJumping=!1)}}},{key:"updatePosition",value:function(t){var e=this.groundHeight+this.radius,i=this.center.x+this.velocity.x*t,n=this.center.y+this.velocity.y*t,o=this.center.z+this.velocity.z*t;this.center.set(i,this.isGrounded?e:n,o)}},{key:"collisionDetection",value:function(){for(var t=this.collisionCandidate,e=this.contactInfo.length=0,i=t.length;e<i;e++){var n=o(this,t[e].a,t[e].b,t[e].c,t[e].normal);n&&(n.face=t[e],this.contactInfo.push(n))}}},{key:"solvePosition",value:function(){var t=void 0,e=void 0,i=new THREE.Vector3,n=new THREE.Vector3,o=new THREE.Vector3,r=new THREE.Vector3,s=new THREE.Vector3;if(0!==this.contactInfo.length){for(var a=0,c=this.contactInfo.length;a<c;a++)if(t=this.contactInfo[a].face,e=this.contactInfo[a].face.normal,!(this.maxSlopeGradient<e.y)){var h=this.maxSlopeGradient<=t.normal.y&&t.normal.y<1;if(this.isJumping&&this.currentJumpPower<=0&&h&&(this.isJumping=!1,this.isGrounded=!0),this.isGrounded||this.isOnSlope){i.copy(e).multiplyScalar(-this.radius).add(this.center),o.set(e.x,0,e.z).normalize();var u=(t.a.dot(e)-(e.x*i.x+e.y*i.y+e.z*i.z))/(e.x*o.x+e.y*o.y+e.z*o.z);n.copy(o).multiplyScalar(u).add(i),r.subVectors(n,i),Math.abs(s.x)>Math.abs(r.x)&&(s.x+=r.x),Math.abs(s.z)>Math.abs(r.z)&&(s.z+=r.z)}else;}this.center.add(s),this.object.position.copy(this.center)}else this.object.position.copy(this.center)}},{key:"setDirection",value:function(){}},{key:"jump",value:function(){this.isJumping||!this.isGrounded||this.isOnSlope||(this.jumpStartTime=Date.now(),this.currentJumpPower=1,this.isJumping=!0)}},{key:"updateJumping",value:function(){if(this.isJumping){var t=(Date.now()-this.jumpStartTime)/1e3;this.currentJumpPower=Math.cos(Math.min(t,1)*Math.PI)}}}]),c}(),b=function(){function n(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}}();var E=87,x=38,w=83,M=40,R=65,V=37,H=68,P=39,z=32,_=Math.PI/180,S=0*_,O=45*_,L=90*_,j=135*_,D=180*_,C=225*_,A=270*_,I=315*_,G=function(t){function e(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e);var t=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t.isDisabled=!1,t.isUp=!1,t.isDown=!1,t.isLeft=!1,t.isRight=!1,t.isMoveKeyHolded=!1,t.frontAngle=0,t._keydownListener=function(t){if(this.isDisabled)return;switch(t.keyCode){case E:case x:this.isUp=!0;break;case w:case M:this.isDown=!0;break;case R:case V:this.isLeft=!0;break;case H:case P:this.isRight=!0;break;case z:this.jump();break;default:return}var e=this.frontAngle;this.updateAngle(),e!==this.frontAngle&&this.dispatchEvent({type:"movekeychange"});(this.isUp||this.isDown||this.isLeft||this.isRight)&&!this.isMoveKeyHolded&&(this.isMoveKeyHolded=!0,this.dispatchEvent({type:"movekeyon"}))}.bind(t),t._keyupListener=function(t){if(this.isDisabled)return;switch(t.keyCode){case E:case x:this.isUp=!1;break;case w:case M:this.isDown=!1;break;case R:case V:this.isLeft=!1;break;case H:case P:this.isRight=!1;break;case z:break;default:return}var e=this.frontAngle;this.updateAngle(),e!==this.frontAngle&&this.dispatchEvent({type:"movekeychange"});this.isUp||this.isDown||this.isLeft||this.isRight||t.keyCode!==E&&t.keyCode!==x&&t.keyCode!==w&&t.keyCode!==M&&t.keyCode!==R&&t.keyCode!==V&&t.keyCode!==H&&t.keyCode!==P||(this.isMoveKeyHolded=!1,this.dispatchEvent({type:"movekeyoff"}))}.bind(t),t._blurListener=function(){this.isUp=!1,this.isDown=!1,this.isLeft=!1,this.isRight=!1,this.isMoveKeyHolded&&(this.isMoveKeyHolded=!1,this.dispatchEvent({type:"movekeyoff"}))}.bind(t),window.addEventListener("keydown",t._keydownListener),window.addEventListener("keyup",t._keyupListener),window.addEventListener("blur",t._blurListener),t}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,d),b(e,[{key:"jump",value:function(){this.dispatchEvent({type:"jumpkeypress"})}},{key:"updateAngle",value:function(){var t=this.isUp,e=this.isDown,i=this.isLeft,n=this.isRight;!t||i||e||n?t&&i&&!e&&!n?this.frontAngle=O:t||!i||e||n?!t&&i&&e&&!n?this.frontAngle=j:t||i||!e||n?!t&&!i&&e&&n?this.frontAngle=C:t||i||e||!n?t&&!i&&!e&&n&&(this.frontAngle=I):this.frontAngle=A:this.frontAngle=D:this.frontAngle=L:this.frontAngle=S}}]),e}();var N=function(){function n(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}}();var J=2*Math.PI,Y=Math.PI/2,W=new THREE.Matrix4,F=new THREE.Matrix4,K=new THREE.Matrix4,U=function(t){function o(t,e){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,o);var n=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(o.__proto__||Object.getPrototypeOf(o)).call(this));return n.camera=t,n.trackObject=e,n.el=i.el||document.body,n.offset=i.offset||new THREE.Vector3(0,0,0),n.radius=i.radius||10,n.minRadius=i.minRadius||1,n.maxRadius=i.maxRadius||30,n.rigidObjects=i.rigidObjects||[],n.lat=0,n.lon=0,n.phi=0,n.theta=0,n.mouseAccelerationX=void 0!==i.mouseAccelerationX?i.mouseAccelerationX:100,n.mouseAccelerationY=void 0!==i.mouseAccelerationY?i.mouseAccelerationY:30,n._pointerStart={x:0,y:0},n._pointerLast={x:0,y:0},n.setNearPlainCornersWithPadding(),n.update(),n._mousedownListener=function(t){this.dispatchEvent({type:"mousedown"}),this._pointerStart.x=t.clientX,this._pointerStart.y=t.clientY,this._pointerLast.x=this.lon,this._pointerLast.y=this.lat,this.el.removeEventListener("mousemove",this._mousedragListener,!1),this.el.addEventListener("mousemove",this._mousedragListener,!1),document.body.classList.add("js-TPSCameraDragging")}.bind(n),n._mouseupListener=function(){this.dispatchEvent({type:"mouseup"}),this.el.removeEventListener("mousemove",this._mousedragListener,!1),document.body.classList.remove("js-TPSCameraDragging")}.bind(n),n._mousedragListener=function(t){var e=this.el.offsetWidth,i=this.el.offsetHeight,n=(this._pointerStart.x-t.clientX)/e*2,o=(this._pointerStart.y-t.clientY)/i*2;this.setLatLon(this._pointerLast.y+o*this.mouseAccelerationY,this._pointerLast.x+n*this.mouseAccelerationX)}.bind(n),n._scrollListener=function(t){t.preventDefault(),t.wheelDeltaY?this.radius-=.05*t.wheelDeltaY/5:t.wheelDelta?this.radius-=.05*t.wheelDelta/5:t.detail&&(this.radius+=t.detail/5);this.radius=Math.max(this.radius,this.minRadius),this.radius=Math.min(this.radius,this.maxRadius)}.bind(n),n.el.addEventListener("mousedown",n._mousedownListener),n.el.addEventListener("mouseup",n._mouseupListener),n.el.addEventListener("mousewheel",n._scrollListener),n.el.addEventListener("DOMMouseScroll",n._scrollListener),n}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(o,d),N(o,[{key:"update",value:function(){this._center=new THREE.Vector3(this.trackObject.matrixWorld.elements[12]+this.offset.x,this.trackObject.matrixWorld.elements[13]+this.offset.y,this.trackObject.matrixWorld.elements[14]+this.offset.z);var t=new THREE.Vector3(Math.cos(this.phi)*Math.cos(this.theta+Y),Math.sin(this.phi),Math.cos(this.phi)*Math.sin(this.theta+Y)),e=this.collisionTest(t.clone().normalize());t.multiplyScalar(e),t.add(this._center),this.camera.position.copy(t),90===this.lat?this.camera.up.set(Math.cos(this.theta+Math.PI),0,Math.sin(this.theta+Math.PI)):-90===this.lat?this.camera.up.set(Math.cos(this.theta),0,Math.sin(this.theta)):this.camera.up.set(0,1,0),this.camera.lookAt(this._center),this.dispatchEvent({type:"updated"})}},{key:"getFrontAngle",value:function(){return J+this.theta}},{key:"setNearPlainCornersWithPadding",value:function(){var t=this.camera.near,e=.5*this.camera.fov,i=Math.tan(e*THREE.Math.DEG2RAD)*t,n=i*this.camera.aspect;this.nearPlainCornersWithPadding=[new THREE.Vector3(-n-t,-i-t,0),new THREE.Vector3(n+t,-i-t,0),new THREE.Vector3(n+t,i+t,0),new THREE.Vector3(-n-t,i+t,0)]}},{key:"setLatLon",value:function(t,e){this.lat=90<t?90:t<-90?-90:t,this.lon=e<0?360+e%360:e%360,this.phi=this.lat*THREE.Math.DEG2RAD,this.theta=-this.lon*THREE.Math.DEG2RAD}},{key:"collisionTest",value:function(t){var e=this.radius;F.makeRotationX(this.phi),K.makeRotationY(this.theta),W.multiplyMatrices(F,K);for(var i=0;i<4;i++){var n=this.nearPlainCornersWithPadding[i].clone();n.applyMatrix4(W);var o=new THREE.Vector3(this._center.x+n.x,this._center.y+n.y,this._center.z+n.z),r=new THREE.Raycaster(o,t,this.camera.near,this.radius).intersectObjects(this.rigidObjects);0!==r.length&&r[0].distance<e&&(e=r[0].distance)}return e}}]),o}();t.install=function(t){T&&t===T?"production"!==process.env.NODE_ENV&&console.error("[THREE] already installed. `install` should be called only once."):T=t},t.World=n,t.Octree=l,t.AnimationController=s,t.CharacterController=g,t.KeyInputControl=G,t.TPSCameraControl=U,Object.defineProperty(t,"__esModule",{value:!0})});
